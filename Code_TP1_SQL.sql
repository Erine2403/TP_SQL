create schema HR;
SET search_path TO HR;

-- Exercice 1 :  Creation de tables --
-- # Question 1--
CREATE TABLE HR.TD_TRAIN_CARTE (
    CD_CARTE VARCHAR(5) NOT NULL,
	TYPE_CARTE VARCHAR(20),
    DESC_CARTE VARCHAR(100),
    PRIX DECIMAL(20,9),
	CONSTRAINT PK_TRAINCARTE PRIMARY KEY (CD_CARTE)
);

CREATE TABLE HR.TD_TRAIN_CLIENT (
    CD_EMAIL INT NOT NULL, 
    LBL_EMAIL VARCHAR(100),
    NOM VARCHAR(20),
    PRENOM VARCHAR(20),
    DATE_DE_NAISSANCE DATE,
    ADRESSE VARCHAR(100),
    CONSTRAINT PK_TRAINCLIENT PRIMARY KEY (CD_EMAIL)
);

CREATE TABLE HR.TD_TRAIN_PAYS(
    CODE_PAYS VARCHAR(5) NOT NULL,
	NOM_PAYS VARCHAR(20),
	CONSTRAINT PK_TRAINPAYS PRIMARY KEY (CODE_PAYS)
);

CREATE TABLE HR.TD_TYPE_TRAIN(
    CD_TRAIN VARCHAR(20) NOT NULL,
	TYPE_TRAIN VARCHAR(50),
	NOMBRE_PLACE INT, 
	CONSTRAINT PK_TYPETRAIN PRIMARY KEY (CD_TRAIN)
);


CREATE TABLE HR.TD_TRAIN_VILLE(
    CD_VOYAGE VARCHAR(20) NOT NULL,
	VILLE_ORIGINE VARCHAR(50) NOT NULL,
	VILLE_DESTINATAIRE VARCHAR(50) NOT NULL, 
	CONSTRAINT PK_TARINVILLE PRIMARY KEY (CD_VOYAGE)
);

CREATE TABLE HR.TF_TRAIN_COMMANDE (
    CD_COMMANDE INT NOT NULL,
    CD_EMAIL INT NOT NULL, 
    CD_TRAIN VARCHAR(20),
    CD_VOYAGE VARCHAR(20) NOT NULL,
    CD_CARTE VARCHAR(5),
    QUANTITE INT NOT NULL,
    DATE_ACHAT DATE,
    MONTANT DECIMAL(20, 9),
    DATE_VOYAGE DATE,
    CODE_PAYS VARCHAR(100),
    CONSTRAINT PK_COMMANDE PRIMARY KEY (CD_COMMANDE), 
    CONSTRAINT FK_CMD_CLIENT FOREIGN KEY (CD_EMAIL) REFERENCES HR.TD_TRAIN_CLIENT(CD_EMAIL),
    CONSTRAINT FK_CMD_TYPE FOREIGN KEY (CD_TRAIN) REFERENCES HR.TD_TYPE_TRAIN(CD_TRAIN),
    CONSTRAINT FK_CMD_VILLE FOREIGN KEY (CD_VOYAGE) REFERENCES HR.TD_TRAIN_VILLE(CD_VOYAGE),
    CONSTRAINT FK_CMD_CARTE FOREIGN KEY (CD_CARTE) REFERENCES HR.TD_TRAIN_CARTE(CD_CARTE),
    CONSTRAINT FK_CMD_PAYS FOREIGN KEY (CODE_PAYS) REFERENCES HR.TD_TRAIN_PAYS(CODE_PAYS)
);

-- # Question 2--
alter schema TP RENAME TO HR; -- # Renommer le schema--

--------------------------------------------------------
--  DDL for Table TD_TRAIN_CARTE
--------------------------------------------------------

Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CAJ','COMMERCIALE','CARTE AVANTAGE JEUNE','49');
Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CAS','COMMERCIALE','CARTE AVANTAGE SENIOR','49');
Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CAA','COMMERCIALE','CARTE AVANTAGE ADULTE','49');
Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CAW','COMMERCIALE','CARTE AVANTAGE WEEKEND','49');
Insert into HR.TD_TRAIN_CARTE (CD_CARTE,TYPE_CARTE,DESC_CARTE,PRIX) values ('CF','FIDELITE','CARTE DE FIDELITE','0');


--------------------------------------------------------
--  DDL for Table TD_TRAIN_CLIENT
--------------------------------------------------------

Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23456','faure.dupont@gmail.com','FAURE','Dupont',to_date('16/05/93','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23457','briche.arnaud@gmail.com','BRICHE','arnaud',to_date('17/08/90','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23458','lamaire.patrick@outlook.com','LAMAIRE','patrick',to_date('01/01/93','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23459','simon.Laura@yahoo.com','SIMON','Laura',to_date('19/08/92','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23460','emeric.fabrice@gmail.com','EMERIC','Fabrice',to_date('25/02/89','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23461','ketouche.delphine@gmail.com','KETOUCHE','delphine',to_date('30/03/80','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23462','ebbar.christine@outlook.com','EBBAR','christine',to_date('22/08/79','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23463','lefebure.duy@gmail.com','LEFEBURE','duy',to_date('16/05/93','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23464','gernigon.vergini@yahoo.com','GERNIGON','vergini',to_date('07/11/85','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23465','mahop.camille@gmail.com','MAHOP','camille',to_date('20/12/87','DD/MM/RR'),null);
Insert into HR.TD_TRAIN_CLIENT (CD_EMAIL,LBL_EMAIL,NOM,PRENOM,DATE_DE_NAISSANCE,ADRESSE) values ('23466','piot.aurélie@gmail.com','PIOT','aurélie',to_date('26/05/93','DD/MM/RR'),null);

--------------------------------------------------------
--  DDL for Table TD_TRAIN_PAYS
--------------------------------------------------------

Insert into HR.TD_TRAIN_PAYS (CODE_PAYS,NOM_PAYS) values ('FR','France');
Insert into HR.TD_TRAIN_PAYS (CODE_PAYS,NOM_PAYS) values ('LU','Luxembourg');
Insert into HR.TD_TRAIN_PAYS (CODE_PAYS,NOM_PAYS) values ('BE','Belgique');

--------------------------------------------------------
--  DDL for Table TD_TYPE_TRAIN
--------------------------------------------------------

Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('TG','TGV INOUI','600');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('OUI','OUIGO','500');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('TR','TER','250');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('EUR','Eurostar','600');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('THA','Thalys','400');
Insert into HR.TD_TYPE_TRAIN (CD_TRAIN,TYPE_TRAIN,NOMBRE_PLACE) values ('INT','Intercités','500');

--------------------------------------------------------
--  DDL for Table TD_TRAIN_VILLE
--------------------------------------------------------

Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('11','PARIS','TOULOUSE');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('89','LYON','MARSEILLE');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('41','TOURS','PARIS');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('21','LILLE','PARIS');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('15','PARIS','Bordeaux');
Insert into HR.TD_TRAIN_VILLE (CD_VOYAGE,VILLE_ORIGINE,VILLE_DESTINATAIRE) values ('51','Bordeaux','PARIS');

--------------------------------------------------------
--  DDL for Table TF_TRAIN_COMMANDE
--------------------------------------------------------

Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1000','23456','TG','11','CAJ','1',to_date('03/11/21','DD/MM/RR'),'80',to_date('01/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1001','23457','OUI','89','CAS','1',to_date('04/10/21','DD/MM/RR'),'10',to_date('02/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1002','23458','TR','41','CAA','1',to_date('05/09/21','DD/MM/RR'),'55',to_date('03/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1003','23459','EUR','21','CAW','1',to_date('06/08/21','DD/MM/RR'),'100',to_date('04/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1004','23460','THA','15','CF','1',to_date('07/07/21','DD/MM/RR'),'98',to_date('05/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1005','23461','INT','51','CAJ','1',to_date('08/06/21','DD/MM/RR'),'66',to_date('06/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1006','23462','TG','11','CAS','1',to_date('09/02/21','DD/MM/RR'),'80',to_date('07/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1007','23463','OUI','89','CAA','1',to_date('10/04/21','DD/MM/RR'),'10',to_date('08/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1008','23464','TR','41','CAW','1',to_date('11/09/21','DD/MM/RR'),'55',to_date('09/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1009','23465','EUR','21','CF','1',to_date('12/01/21','DD/MM/RR'),'100',to_date('10/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1010','23466','THA','15','CAJ','1',to_date('13/06/21','DD/MM/RR'),'98',to_date('11/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1011','23456','TG','51','CAS','1',to_date('14/06/21','DD/MM/RR'),'66',to_date('12/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1012','23457','OUI','11','CAA','1',to_date('15/03/21','DD/MM/RR'),'80',to_date('13/02/20','DD/MM/RR'),null);
Insert into HR.TF_TRAIN_COMMANDE (CD_COMMANDE,CD_EMAIL,CD_TRAIN,CD_VOYAGE,CD_CARTE,QUANTITE,DATE_ACHAT,MONTANT,DATE_VOYAGE,CODE_PAYS) values ('1013','23458','TR','89','CAW','1',to_date('16/05/21','DD/MM/RR'),'10',to_date('14/02/20','DD/MM/RR'),null);

-- Exercice 2 : Questions SQL --
-- # Question 1--
SELECT CD_COMMANDE, CD_EMAIL, MONTANT
FROM HR.TF_TRAIN_COMMANDE
WHERE MONTANT > 80.00;

-- # Question 2--
SELECT CD_COMMANDE, CD_EMAIL,DATE_VOYAGE
FROM HR.TF_TRAIN_COMMANDE
WHERE DATE_VOYAGE < TO_DATE('10/02/2020', 'DD/MM/YYYY');

-- # Question 3--

SELECT CD_EMAIL, COUNT(*) AS nombre_doublons
FROM HR.TF_TRAIN_COMMANDE
GROUP BY CD_EMAIL
HAVING COUNT(*) > 1;

-- # Question 4--
SELECT CD_COMMANDE, CD_EMAIL
FROM HR.TF_TRAIN_COMMANDE
WHERE CD_COMMANDE >= 2;
-- # Test groupby --
SELECT CD_EMAIL
FROM HR.TF_TRAIN_COMMANDE
GROUP BY CD_EMAIL
HAVING COUNT(CD_COMMANDE) >= 2;

-- # Question 5--

SELECT  a.NOM, a.PRENOM, a.LBL_EMAIL
FROM HR.TD_TRAIN_CLIENT a
JOIN HR.TF_TRAIN_COMMANDE b ON a.CD_EMAIL = b.CD_EMAIL
JOIN HR.TD_TRAIN_VILLE c ON c.CD_VOYAGE = b.CD_VOYAGE
WHERE c.VILLE_ORIGINE = 'LYON' AND c.VILLE_DESTINATAIRE = 'MARSEILLE';

-- # Question 6--

SELECT c.NOM, c.PRENOM, c.LBL_EMAIL, carte.TYPE_CARTE
FROM HR.TF_TRAIN_COMMANDE tc
JOIN HR.TD_TRAIN_CLIENT c ON tc.CD_EMAIL = c.CD_EMAIL
JOIN HR.TD_TRAIN_CARTE carte ON tc.CD_CARTE = carte.CD_CARTE
WHERE tc.CD_VOYAGE IN (
    SELECT v1.CD_VOYAGE
    FROM HR.TD_TRAIN_VILLE v1
    WHERE (v1.VILLE_ORIGINE = 'PARIS' AND v1.VILLE_DESTINATAIRE = 'TOULOUSE')
       OR (v1.VILLE_ORIGINE = 'BORDEAUX' AND v1.VILLE_DESTINATAIRE = 'PARIS')
);

-------------------------------
SELECT a.NOM, a.PRENOM, a.LBL_EMAIL, c.TYPE_CARTE
FROM HR.TD_TRAIN_CLIENT a
JOIN HR.TF_TRAIN_COMMANDE b ON a.CD_EMAIL = b.CD_EMAIL
JOIN HR.TD_TRAIN_CARTE c ON c.CD_CARTE = b.CD_CARTE
WHERE b.CD_VOYAGE IN (
    SELECT v1.CD_VOYAGE
    FROM HR.TD_TRAIN_VILLE v1
    WHERE (v1.VILLE_ORIGINE = 'PARIS' AND v1.VILLE_DESTINATAIRE = 'TOULOUSE')
       OR (v1.VILLE_ORIGINE = 'BORDEAUX' AND v1.VILLE_DESTINATAIRE = 'PARIS')
);


